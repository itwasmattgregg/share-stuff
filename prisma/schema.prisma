datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id    String  @id @default(cuid())
  email String  @unique
  name  String?
  role  String  @default("USER")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  password Password?

  // Community relationships
  ownedCommunities     Community[]           @relation("CommunityOwner")
  communityMemberships CommunityMembership[]
  items                Item[]
  lendingRequests      LendingRequest[]      @relation("Requester")
  receivedRequests     LendingRequest[]      @relation("ItemOwner")
  reports              Report[]
}

model Password {
  hash String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId String @unique
}

model Community {
  id          String  @id @default(cuid())
  name        String
  description String?
  rules       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  ownerId String
  owner   User   @relation("CommunityOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  memberships CommunityMembership[]
}

model CommunityMembership {
  id     String @id @default(cuid())
  status String @default("PENDING")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  communityId String
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
}

model Item {
  id          String  @id @default(cuid())
  name        String
  description String?
  category    String? // e.g., "book", "tool", "dvd", "game"
  condition   String? // e.g., "excellent", "good", "fair"
  isAvailable Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  lendingRequests LendingRequest[]
}

model LendingRequest {
  id           String  @id @default(cuid())
  status       String  @default("PENDING")
  requestNote  String?
  responseNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  requesterId String
  requester   User   @relation("Requester", fields: [requesterId], references: [id], onDelete: Cascade)

  itemOwnerId String
  itemOwner   User   @relation("ItemOwner", fields: [itemOwnerId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  // Removed unique constraint to allow multiple requests per item
}

model Report {
  id          String  @id @default(cuid())
  reportType  String
  targetId    String // ID of the user or community being reported
  reason      String
  description String
  evidence    String?
  status      String  @default("PENDING")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  reporterId String
  reporter   User   @relation(fields: [reporterId], references: [id], onDelete: Cascade)
}
